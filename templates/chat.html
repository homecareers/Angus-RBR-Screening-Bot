<!DOCTYPE html>
<html>
<head>
  <title>ANGUS‚Ñ¢ Survey Bot ‚Äî Elite Cinematic Edition</title>
  <style>
    body { 
      font-family: 'Inter', Arial, sans-serif; 
      background: #111; 
      color: #eee; 
      margin: 0; 
      padding: 20px; 
      min-height: 100vh;
    }
    .chat-box { 
      max-width: 600px; 
      margin: 50px auto; 
      background: #1a1a1a; 
      padding: 30px; 
      border-radius: 12px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    .message { 
      margin: 15px 0; 
      line-height: 1.6;
      animation: fadeIn 0.5s ease-in;
    }
    .bot { 
      color: #33E1FF;
      font-weight: 500;
    }
    .user { 
      color: #00B4D8;
      text-align: right; 
      font-weight: 500;
    }
    .options { 
      margin: 20px 0; 
    }
    .options button { 
      display: block; 
      margin: 8px 0; 
      width: 100%; 
      padding: 12px 16px; 
      border: 1px solid #00FFC8; 
      border-radius: 8px; 
      background: #1e1e1e; 
      color: #00FFC8; 
      cursor: pointer; 
      font-size: 14px;
      transition: all 0.25s ease;
      text-align: left;
      letter-spacing: 0.3px;
    }
    .options button:hover {
      background: #33E1FF;
      color: #000;
      transform: translateY(-2px);
      box-shadow: 0 0 14px rgba(0,255,200,0.45);
    }
    input {
      width: 100%;
      padding: 12px;
      margin-top: 15px;
      border: 2px solid #00FFC8;
      border-radius: 8px;
      background: #222;
      color: #fff;
      font-size: 16px;
      box-sizing: border-box;
    }
    input:focus {
      outline: none;
      border-color: #33E1FF;
      box-shadow: 0 0 10px rgba(51,225,255,0.3);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .loading {
      color: #33E1FF;
      font-style: italic;
    }
    .loading::after {
      content: '';
      animation: dots 1.5s infinite;
    }
    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }
  </style>
</head>
<body>
  <div class="chat-box" id="chat"></div>

  <script>
    /* ---------------------- Survey Questions ---------------------- */
    const surveyFlow = [
      {
        question: "When you picture your future, which one gets you fired up the most?",
        options: [
          "üå¥ More time freedom for adventures",
          "üí∞ Extra income (bye-bye money stress)",
          "üîÑ Total career change (fresh chapter)",
          "ü§ù Belonging to a mission-driven community",
          "‚úçÔ∏è Other"
        ]
      },
      {
        question: "If building your future was a Netflix series, how many hours a week would you binge it?",
        options: [
          "üé¨ 3‚Äì5 hours (side hustle pilot season)",
          "üì∫ 5‚Äì10 hours (mini-series)",
          "üçø 10‚Äì15 hours (serious season arc)",
          "üé• 15+ hours (full box set, I'm all in)"
        ]
      },
      {
        question: "Every hero's got a storyline ‚Äî which best describes yours so far?",
        options: [
          "‚ú® Total newbie (fresh chapter, blank page)",
          "üòÖ Tried before, but plot twist: it didn't work out",
          "üèÜ Tried before and crushed it (looking for the sequel)"
        ]
      },
      {
        question: "If I dropped a simple game plan in your lap today, when would you press play?",
        options: [
          "üöÄ Right now, let's roll",
          "üìÜ Within 30 days",
          "‚è≥ 2‚Äì3 months out",
          "üëÄ Just exploring the trailer for now"
        ]
      },
      {
        question: "On a 1‚Äì10 confidence scale, where are you right now?",
        options: ["1Ô∏è‚É£ 1","2Ô∏è‚É£ 2","3Ô∏è‚É£ 3","4Ô∏è‚É£ 4","5Ô∏è‚É£ 5","6Ô∏è‚É£ 6","7Ô∏è‚É£ 7","8Ô∏è‚É£ 8","9Ô∏è‚É£ 9","üîü 10"]
      },
      {
        question: "In a team setting, what lights you up the most?",
        options: [
          "ü§ù Connecting & building relationships (Pearl)",
          "üéâ Recognition & being celebrated (Ruby)",
          "üìä Having clear systems & structure (Sapphire)",
          "üíé Hitting goals & building wealth (Emerald)"
        ]
      }
    ];

    let answers = [];
    let step = 0;
    let userEmail = "";

    /* ---------------------- Message Functions ---------------------- */
    function showBotMessage(msg) {
      const chatDiv = document.getElementById("chat");
      chatDiv.innerHTML += `<div class='message bot'>${msg}</div>`;
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function showUserMessage(msg) {
      const chatDiv = document.getElementById("chat");
      chatDiv.innerHTML += `<div class='message user'>${msg}</div>`;
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function showLoading() {
      const chatDiv = document.getElementById("chat");
      chatDiv.innerHTML += `<div class='message loading' id='loading'>ANGUS is thinking</div>`;
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function hideLoading() {
      const loadingDiv = document.getElementById('loading');
      if (loadingDiv) loadingDiv.remove();
    }

    /* ---------------------- Survey Logic ---------------------- */
    function askNext() {
      if (step < surveyFlow.length) {
        showLoading();
        setTimeout(() => {
          hideLoading();

          let q = surveyFlow[step];
          showBotMessage(`<strong>Question ${step + 1} of 6:</strong><br><br>${q.question}`);

          let optionsHTML = "<div class='options'>";
          q.options.forEach(opt => {
            const escapedOpt = opt.replace(/'/g, "\\'");
            optionsHTML += `<button onclick="selectOption('${escapedOpt}')">${opt}</button>`;
          });
          optionsHTML += "</div>";

          document.getElementById("chat").innerHTML += optionsHTML;
        }, 800);
      } else {
        askForEmail();
      }
    }

    function selectOption(option) {
      document.querySelectorAll('.options').forEach(div => div.remove());
      showUserMessage(option);
      answers.push(option);
      step++;
      setTimeout(() => askNext(), 400);
    }

    /* ---------------------- Email Step ---------------------- */
    function askForEmail() {
      showLoading();
      setTimeout(() => {
        hideLoading();
        showBotMessage("Last thing ‚Äî what‚Äôs the email you used to download your Real Brick Road‚Ñ¢ booklet?<br><br>That‚Äôs how I‚Äôll keep your answers linked to your record.");

        document.getElementById("chat").innerHTML += `
          <input id="emailInput" type="email" placeholder="Enter your email address" onkeydown="if(event.key==='Enter'){saveEmail();}">
        `;
        document.getElementById("emailInput").focus();
      }, 600);
    }

    function saveEmail() {
      const email = document.getElementById("emailInput").value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (!email) {
        showBotMessage("‚ö†Ô∏è Please enter your email.");
        return;
      }
      if (!emailRegex.test(email)) {
        showBotMessage("‚ö†Ô∏è That email doesn‚Äôt look valid. Try again.");
        return;
      }

      userEmail = email;
      showUserMessage(email);
      document.getElementById("emailInput").remove();

      submitSurvey();
    }

    /* ---------------------- Submit + Follow Backend Redirect ---------------------- */
    function submitSurvey() {
      showLoading();

      const surveyData = { 
        email: userEmail,
        answers: answers 
      };

      // ‚≠ê We NOW wait for the backend redirect.
      fetch("/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(surveyData)
      })
      .then(response => {
          if (response.redirected) {
              // ‚≠ê This is the correct nextstep URL with ?uid=<GHL_USER_ID>
              window.location.href = response.url;
          } else {
              showBotMessage("Hmm... something glitched. Try again.");
              console.error("No redirect received from backend:", response);
          }
      })
      .catch(err => {
          console.error("Error submitting survey:", err);
          showBotMessage("‚ö†Ô∏è There was an issue sending your answers. Please try again.");
      });
    }

    /* ---------------------- Intro Message ---------------------- */
    window.onload = () => { 
      showBotMessage("What's up, legend?! I'm ANGUS‚Ñ¢ ‚Äî the strategist behind the curtain of The Real Brick Road‚Ñ¢. My job is simple: ask you six gut-punch honest questions and hand you a personalized path forward. No fluff. No pressure. Just clarity.<br><br>Ready?");
      setTimeout(() => askNext(), 1800);
    }
  </script>
</body>
</html>
